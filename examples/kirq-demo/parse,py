#!/usr/bin/env python3
"""
QKD Python Concatenator - Combines important Python files into a single file

This script scans a repository for Python files related to QKD and concatenates
them into a single output file for easy sharing.
"""

import os
import re
from datetime import datetime

# Keywords to identify QKD-related files
QKD_KEYWORDS = ['qkd', 'key', 'quantum', 'etsi', 'sae', 'encrypt', 'decrypt', 'auth']

def is_qkd_related(file_path):
    """Check if a file is likely QKD-related based on name and content"""
    # First check the filename
    filename = os.path.basename(file_path).lower()
    if any(kw in filename for kw in QKD_KEYWORDS):
        return True
    
    # Then check file content for keywords
    try:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read().lower()
            # Check for multiple keywords to increase confidence
            keyword_count = sum(1 for kw in QKD_KEYWORDS if kw in content)
            return keyword_count >= 2  # File must contain at least 2 keywords
    except Exception:
        return False

def concatenate_files(repo_path, output_file):
    """Concatenate important QKD-related Python files into a single file"""
    python_files = []
    
    # Find all Python files in the repository
    for root, _, files in os.walk(repo_path):
        for file in files:
            if file.endswith('.py'):
                file_path = os.path.join(root, file)
                python_files.append(file_path)
    
    print(f"Found {len(python_files)} Python files")
    
    # Filter for QKD-related files
    qkd_files = [f for f in python_files if is_qkd_related(f)]
    print(f"Identified {len(qkd_files)} QKD-related files")
    
    # Sort files by importance (files with more QKD keywords first)
    def count_keywords(file_path):
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read().lower()
                return sum(content.count(kw) for kw in QKD_KEYWORDS)
        except Exception:
            return 0
    
    qkd_files.sort(key=count_keywords, reverse=True)
    
    # Concatenate files
    with open(output_file, 'w', encoding='utf-8') as outfile:
        outfile.write(f"# KIRQ Python QKD App - Concatenated Files\n")
        outfile.write(f"# Generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        
        for file_path in qkd_files:
            rel_path = os.path.relpath(file_path, repo_path)
            outfile.write(f"\n\n{'='*80}\n")
            outfile.write(f"# FILE: {rel_path}\n")
            outfile.write(f"{'='*80}\n\n")
            
            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as infile:
                    content = infile.read()
                    outfile.write(content)
            except Exception as e:
                outfile.write(f"# Error reading file: {str(e)}\n")
    
    print(f"Concatenated {len(qkd_files)} files into {output_file}")
    return qkd_files

def main():
    import argparse
    parser = argparse.ArgumentParser(description='Concatenate QKD-related Python files')
    parser.add_argument('repo_path', help='Path to the repository')
    parser.add_argument('--output', default='kirq_qkd_code.py', help='Output file')
    args = parser.parse_args()
    
    concatenate_files(args.repo_path, args.output)

if __name__ == "__main__":
    main()
